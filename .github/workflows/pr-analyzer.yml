# GitHub Actions Reusable Workflow for PR Analyzer
# This workflow can be called from other repositories to analyze their pull requests

name: PR Analyzer

on:
  # Allow this workflow to be called from other repositories
  workflow_call:
    secrets:
      AZURE_OPENAI_ENDPOINT:
        required: true
        description: 'Azure OpenAI endpoint URL'
      AZURE_OPENAI_API_KEY:
        required: true
        description: 'Azure OpenAI API key'
      AZURE_OPENAI_DEPLOYMENT:
        required: true
        description: 'Azure OpenAI deployment name'
      GITHUB_TOKEN:
        required: false
        description: 'GitHub token for API access (automatically provided if not specified)'
  
  # Also allow direct triggers for testing in this repo
  pull_request:
    branches:
      - develop
      - master
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  analyze-pr:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout PR code (calling repository)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
      
      - name: Checkout analyzer code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/pr-analyzer
          path: .pr-analyzer
          fetch-depth: 1
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Display Python version
        run: |
          python --version
          pip --version
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r .pr-analyzer/requirements.txt
      
      - name: Verify GitHub Token
        run: |
          if [ -n "${{ secrets.APP_SECRET_TOKEN }}" ]; then
            echo "✅ APP_SECRET_TOKEN is set (length: ${#GITHUB_TOKEN})"
            echo "Token prefix: ${GITHUB_TOKEN:0:7}..."
          else
            echo "❌ APP_SECRET_TOKEN is NOT set"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.APP_SECRET_TOKEN }}
      
      - name: Analyze Pull Request
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          GITHUB_TOKEN: ${{ secrets.APP_SECRET_TOKEN }}
          BUILD_REPOSITORY_PROVIDER: "GitHub"
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          BUILD_REPOSITORY_NAME: ${{ github.repository }}
          SYSTEM_PULLREQUEST_PULLREQUESTID: ${{ github.event.pull_request.number }}
        working-directory: .pr-analyzer
        run: python main.py
